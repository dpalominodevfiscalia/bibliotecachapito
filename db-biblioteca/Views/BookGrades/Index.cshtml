@model BibliotecaDB.Models.BookGradesViewModel

@{
    ViewData["Title"] = "Libros por Grado";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Libros por Grado</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                        <li class="breadcrumb-item active">Libros por Grado</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Libros por Grado</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (Model.CurrentGradoId.HasValue)
                            {
                                <div class="alert alert-info">
                                    Mostrando libros para el grado: <strong>@Model.CurrentGradoNombre</strong>
                                </div>
                            }

                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    @if (ViewContext.HttpContext.Items["HasCreateBookGradePermission"] as bool? ?? false)
                                    {
                                        <button title="Crear Nuevo" type="button" class="btn btn-success" data-toggle="modal" data-target="#createModal">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    }
                                </div>
                                <div class="action-buttons">
                                    @if (ViewContext.HttpContext.Items["HasEditBookGradePermission"] as bool? ?? false)
                                    {
                                        <button type="button" class="btn btn-primary btn-sm" id="editSelected" disabled>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    }
                                    @if (ViewContext.HttpContext.Items["HasDetailsBookGradePermission"] as bool? ?? false)
                                    {
                                        <button type="button" class="btn btn-info btn-sm" id="detailsSelected" disabled>
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    }
                                    @if (ViewContext.HttpContext.Items["HasDeleteBookGradePermission"] as bool? ?? false)
                                    {
                                        <button type="button" class="btn btn-danger btn-sm" id="deleteSelected" disabled>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    }
                                    @if (ViewContext.HttpContext.Items["HasToggleBookGradePermission"] as bool? ?? false)
                                    {
                                        <button type="button" class="btn btn-warning btn-sm" id="toggleSelected" disabled>
                                            <i class="fas fa-power-off"></i> <span id="toggleButtonText"></span>
                                        </button>
                                    }
                                </div>
                            </div>

                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="radio" name="selectBookGrade" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th>Libro</th>
                                        <th>Grado</th>
                                        <th>Cantidad</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var bookGrade in Model.LibroGrados)
                                    {
                                        <tr>
                                            <td>
                                                <input type="radio" name="selectBookGrade" class="bookgrade-radio" value="@bookGrade.Id" data-bookgradename="@bookGrade.Libro.Titulo - @bookGrade.Grado.Nombre" data-state="@bookGrade.Estado" onchange="handleBookGradeSelection()">
                                            </td>
                                            <td>@bookGrade.Libro.Titulo</td>
                                            <td>@bookGrade.Grado.Nombre</td>
                                            <td>@bookGrade.Cantidad</td>
                                            <td>
                                                @if (bookGrade.Estado == "Activo")
                                                {
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check-circle"></i> @bookGrade.Estado
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-danger">
                                                        <i class="fas fa-times-circle"></i> @bookGrade.Estado
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Crear Libro por Grado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="createModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Libro por Grado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="editModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalles de Libro por Grado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="detailsModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toggle Modal -->
<div class="modal fade" id="toggleModal" tabindex="-1" role="dialog" aria-labelledby="toggleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="toggleModalLabel">Confirmar Cambio de Estado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="toggleModalMessage">¿Está seguro de que desea <span id="toggleActionText"></span> este libro por grado?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmToggle">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Eliminar Libro por Grado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="deleteModalContent"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        var selectedBookGradeId = null;
        var selectedBookGradeName = null;
        var selectedBookGradeState = null;

        function handleBookGradeSelection() {
            var radio = event.target;
            if (radio.checked) {
                selectedBookGradeId = radio.value;
                selectedBookGradeName = radio.dataset.bookgradename;
                selectedBookGradeState = radio.dataset.state;

                // Update toggle button text based on bookgrade state
                $('#toggleButtonText').text(selectedBookGradeState === "Activo" ? "Desactivar" : "Activar");

                // Enable action buttons
                $('#editSelected').prop('disabled', false);
                $('#detailsSelected').prop('disabled', false);
                $('#deleteSelected').prop('disabled', false);
                $('#toggleSelected').prop('disabled', false);
            }
        }

        function toggleSelectAll() {
            var radios = document.querySelectorAll('.bookgrade-radio');
            radios.forEach(function(radio) {
                radio.checked = false;
            });
            selectedBookGradeId = null;
            selectedBookGradeName = null;
            selectedBookGradeState = null;

            // Disable action buttons
            $('#editSelected').prop('disabled', true);
            $('#detailsSelected').prop('disabled', true);
            $('#deleteSelected').prop('disabled', true);
            $('#toggleSelected').prop('disabled', true);
        }

        $(document).ready(function() {
            // Handle modal loading via AJAX
            $('#createModal').on('show.bs.modal', function (event) {
                var modal = $(this);
                var url = '@Url.Action("Create")';
                // Pass gradoId parameter if filtering by grade is active
                @if (Model.CurrentGradoId.HasValue && Model.CurrentGradoId.Value > 0) {
                    <text>
                    url += '?gradoId=' + @Model.CurrentGradoId.Value;
                    </text>
                }
                $.get(url, function(data) {
                    modal.find('#createModalContent').html(data);
                });
            });

            // Handle action buttons
            $('#editSelected').click(function() {
                if (selectedBookGradeId) {
                    var url = '@Url.Action("Edit", new { id = "__id__" })'.replace('__id__', selectedBookGradeId);
                    $.get(url, function(data) {
                        $('#editModalContent').html(data);
                        $('#editModal').modal('show');
                    });
                }
            });

            $('#detailsSelected').click(function() {
                if (selectedBookGradeId) {
                    var url = '@Url.Action("Details", new { id = "__id__" })'.replace('__id__', selectedBookGradeId);
                    $.get(url, function(data) {
                        $('#detailsModalContent').html(data);
                        $('#detailsModal').modal('show');
                    });
                }
            });

            $('#deleteSelected').click(function() {
                if (selectedBookGradeId) {
                    var url = '@Url.Action("Delete", new { id = "__id__" })'.replace('__id__', selectedBookGradeId);
                    $.get(url, function(data) {
                        $('#deleteModalContent').html(data);
                        $('#deleteModal').modal('show');
                    });
                }
            });

            $('#toggleSelected').click(function() {
                if (selectedBookGradeId) {
                    var actionText = selectedBookGradeState === "Activo" ? "desactivar" : "activar";
                    $('#toggleActionText').text(actionText);
                    $('#toggleModal').modal('show');
                    $('#confirmToggle').data('id', selectedBookGradeId).data('url', '@Url.Action("ToggleEstado")');
                }
            });

            // Handle form submission via AJAX
            $(document).on('submit', 'form', function(e) {
                e.preventDefault();
                var form = $(this);
                var url = form.attr('action');
                var method = form.attr('method') || 'POST';

                // Get form data including anti-forgery token
                var formData = new FormData(form[0]);

                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(result) {
                        if (result.success) {
                            // Show success message
                            if (result.message) {
                                toastr.success(result.message);
                            }
                            // Close modal and refresh page after delay
                            $('.modal').modal('hide');
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            // Show validation errors
                            form.replaceWith(result);
                        }
                    },
                    error: function(xhr) {
                        // Handle error
                        console.log(xhr.responseText);
                        if (xhr.status == 200 && xhr.responseText) {
                            // This might be HTML with validation errors
                            form.replaceWith(xhr.responseText);
                        } else if (xhr.status == 400 && xhr.responseText) {
                            // Handle validation errors
                            form.replaceWith(xhr.responseText);
                        }
                    }
                });
            });

            // Handle toggle modal
            $('#toggleModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var id = button.data('id');
                var url = button.data('action');
                var currentState = button.data('current-state');

                var modal = $(this);
                var actionText = currentState === "Activo" ? "desactivar" : "activar";
                modal.find('#toggleActionText').text(actionText);
                modal.find('#confirmToggle').data('id', id).data('url', url);
            });

            $('#confirmToggle').click(function() {
                var id = $(this).data('id');
                var url = $(this).data('url');

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: { id: id },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(result) {
                        if (result.success) {
                            toastr.success('Estado actualizado exitosamente');
                            $('#toggleModal').modal('hide');
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        }
                    },
                    error: function(xhr) {
                        toastr.error('Error al actualizar el estado');
                    }
                });
            });
        });
    </script>
}