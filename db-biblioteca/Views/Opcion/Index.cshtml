@model IEnumerable<BibliotecaDB.Models.MenuItem>
@inject BibliotecaDB.Services.DataService _dataService

@{
    ViewData["Title"] = "Opciones";
}


<div class="d-flex justify-content-between mb-3">
    <div class="d-flex align-items-center">
        <button type="button" class="btn btn-success mr-3" data-toggle="modal" data-target="#createModal" title="Crear Nuevo Elemento de Menú">
            <i class="fas fa-plus"></i>
        </button>
        <a asp-action="BulkAssign" class="btn btn-info mr-3" title="Asignar Acciones de Menú Masivas" style="display:none;">
            <i class="fas fa-tasks"></i> Asignar Acciones de Menú Masivas
        </a>
        <div class="action-buttons">
            <button type="button" class="btn btn-primary btn-sm" id="editSelected" disabled>
                <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn btn-info btn-sm" id="detailsSelected" disabled data-toggle="modal" data-target="#detailsModal">
                <i class="fas fa-info-circle"></i>
            </button>
            <button type="button" class="btn btn-danger btn-sm" id="deleteSelected" disabled>
                <i class="fas fa-trash"></i>
            </button>
            <button type="button" class="btn btn-warning btn-sm" id="toggleSelected" disabled>
                <i class="fas fa-power-off"></i> <span id="toggleButtonText"> </span>
            </button>
        </div>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Búsqueda y Filtros</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="searchInput">Búsqueda Global:</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar en todas las columnas...">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label for="titleFilter">Título:</label>
                    <input type="text" class="form-control" id="titleFilter" placeholder="Filtrar título...">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label for="urlFilter">URL:</label>
                    <input type="text" class="form-control" id="urlFilter" placeholder="Filtrar URL...">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label for="moduleFilter">Módulo:</label>
                    <select class="form-control" id="moduleFilter">
                        <option value="">Todos</option>
                        @foreach (var modulo in _dataService.GetModulos())
                        {
                            <option value="@modulo.Nombre">@modulo.Nombre</option>
                        }
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label for="stateFilter">Estado:</label>
                    <select class="form-control" id="stateFilter">
                        <option value="">Todos</option>
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12 text-right">
                <button class="btn btn-secondary" id="clearFilters">Limpiar Filtros</button>
                <button class="btn btn-primary" id="applyFilters">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>
<table class="table">
    <thead>
        <tr>
            <th></th>
            <th>
                @Html.DisplayNameFor(model => model.Title)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Url)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Icon)
            </th>
            <th>
                Módulo
            </th>
            <th>
                Perfiles
            </th>
            <th>
                Roles
            </th>
            <th>
                Acciones
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Estado)
            </th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @{
                        var permissions = ViewBag.ActionPermissions as Dictionary<int, Dictionary<string, bool>>;
                        var itemPermissions = permissions != null && permissions.ContainsKey(item.Id) ? permissions[item.Id] : new Dictionary<string, bool>();
                        var canEdit = itemPermissions.ContainsKey("Editar") && itemPermissions["Editar"];
                        var canDelete = itemPermissions.ContainsKey("Eliminar") && itemPermissions["Eliminar"];
                        var canDetails = itemPermissions.ContainsKey("Detalles") && itemPermissions["Detalles"];
                        var canToggle = itemPermissions.ContainsKey("ToggleEstado") && itemPermissions["ToggleEstado"];
                    }

                    <input type="radio" name="selectOpcion" class="opcion-radio" value="@item.Id" data-opcionname="@item.Title" data-state="@item.Estado" onchange="handleOpcionSelection()">
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Title)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Url)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Icon)
                </td>
                <td>
                    @{
                        var modulo = _dataService.GetModuloById(item.ModuloId);
                        if (modulo != null)
                        {
                            @modulo.Nombre
                        }
                        else
                        {
                            @: N/A
                        }
                    }
                </td>
                <td>
                    @if (item.Profiles != null && item.Profiles.Any())
                    {
                        @string.Join(", ", item.Profiles)
                    }
                    else
                    {
                        @: N/A
                    }
                </td>
                <td>
                    @if (item.Roles != null && item.Roles.Any())
                    {
                        @string.Join(", ", item.Roles)
                    }
                    else
                    {
                        @: N/A
                    }
                </td>
                <td>
                    @{
                        var actionNames = _dataService.GetActionNamesFromIds(item.ActionIds);
                        @actionNames
                    }
                </td>
                <td>
                    @if (item.Estado == "Activo")
                    {
                        <span class="badge badge-success">
                            <i class="fas fa-check-circle"></i> @item.Estado
                        </span>
                    }
                    else
                    {
                        <span class="badge badge-danger">
                            <i class="fas fa-times-circle"></i> @item.Estado
                        </span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Crear Elemento de Menú</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="createModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Elemento de Menú</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="editModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalles de Elemento de Menú</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="detailsModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Eliminar Elemento de Menú</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="deleteModalContent"></div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        $(document).ready(function() {
            // Handle modal loading via AJAX
            $('#createModal').on('show.bs.modal', function (event) {
                var modal = $(this);
                $.get('@Url.Action("Create")', function(data) {
                    modal.find('#createModalContent').html(data);
                });
            });


            // Details modal loading is now handled by the click handler below
            // $('#detailsModal').on('show.bs.modal', function (event) {
            //     var button = $(event.relatedTarget);
            //     var url = button.data('action');
            //     var modal = $(this);
            //     $.get(url, function(data) {
            //         modal.find('#detailsModalContent').html(data);
            //     });
            // });


            // Handle form submission via AJAX
            $(document).on('submit', 'form', function(e) {
                e.preventDefault();
                var form = $(this);
                var url = form.attr('action');
                var method = form.attr('method') || 'POST';

                // Get form data including anti-forgery token
                var formData = new FormData(form[0]);

                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(result) {
                        if (result.success) {
                            // Show success message
                            if (result.message) {
                                toastr.success(result.message);
                            }
                            // Close modal and refresh page after delay
                            $('.modal').modal('hide');
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            // Show validation errors
                            form.replaceWith(result);
                        }
                    },
                    error: function(xhr) {
                        // Handle error
                        console.log(xhr.responseText);
                        if (xhr.status == 200 && xhr.responseText) {
                            // This might be HTML with validation errors
                            form.replaceWith(xhr.responseText);
                        } else if (xhr.status == 400 && xhr.responseText) {
                            // Handle validation errors
                            form.replaceWith(xhr.responseText);
                        }
                    }
                });
            });
        });

        var selectedOpcionId = null;
        var selectedOpcionName = null;
        var selectedOpcionState = null;

        function handleOpcionSelection() {
            var radio = event.target;
            if (radio.checked) {
                selectedOpcionId = radio.value;
                selectedOpcionName = radio.dataset.opcionname;
                selectedOpcionState = radio.dataset.state;

                // Update toggle button text based on state
                // Always show "Desactivar" since the action is the same (toggle state)
                $('#toggleButtonText').text("Desactivar");

                // Enable action buttons
                $('#editSelected').prop('disabled', false);
                $('#detailsSelected').prop('disabled', false);
                $('#deleteSelected').prop('disabled', false);
                $('#toggleSelected').prop('disabled', false);

                // Add visual feedback
                console.log('Opción seleccionada: ' + selectedOpcionName + ' (ID: ' + selectedOpcionId + ', Estado: ' + selectedOpcionState + ')');
                toastr.info('Opción seleccionada: ' + selectedOpcionName);
            }
        }

        function toggleSelectAll() {
            var radios = document.querySelectorAll('.opcion-radio');
            radios.forEach(function(radio) {
                radio.checked = false;
            });
            selectedOpcionId = null;
            selectedOpcionName = null;
            selectedOpcionState = null;

            // Disable action buttons
            $('#editSelected').prop('disabled', true);
            $('#detailsSelected').prop('disabled', true);
            $('#deleteSelected').prop('disabled', true);
            $('#toggleSelected').prop('disabled', true);
        }

        function toggleEstado(id, url) {
            $.ajax({
                url: url,
                type: 'POST',
                data: { id: id },
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(result) {
                    if (result.success) {
                        toastr.success('Estado actualizado exitosamente');
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    }
                },
                error: function(xhr) {
                    toastr.error('Error al actualizar el estado');
                }
            });
        }

        // Handle action buttons
        $('#editSelected').click(function() {
            if (selectedOpcionId) {
                var url = '@Url.Action("Edit", new { id = "__id__" })'.replace('__id__', selectedOpcionId);
                $.get(url, function(data) {
                    $('#editModalContent').html(data);
                    $('#editModal').modal('show');
                    console.log('Edit modal loaded with data:', data);
                }).fail(function(xhr) {
                    console.error('Error loading edit modal:', xhr.responseText);
                    toastr.error('Error al cargar el formulario de edición: ' + xhr.status + ' - ' + xhr.statusText);
                });
            } else {
                toastr.warning('Por favor seleccione una opción para editar');
            }
        });

        $('#detailsSelected').click(function() {
            if (selectedOpcionId) {
                var url = '@Url.Action("Details", new { id = "__id__" })'.replace('__id__', selectedOpcionId);
                $.get(url, function(data) {
                    $('#detailsModalContent').html(data);
                    $('#detailsModal').modal('show');
                    console.log('Details modal loaded with data:', data);
                }).fail(function(xhr) {
                    console.error('Error loading details modal:', xhr.responseText);
                    toastr.error('Error al cargar los detalles: ' + xhr.status + ' - ' + xhr.statusText);
                });
            } else {
                toastr.warning('Por favor seleccione una opción para ver detalles');
            }
        });

        $('#deleteSelected').click(function() {
            if (selectedOpcionId) {
                var url = '@Url.Action("Delete", new { id = "__id__" })'.replace('__id__', selectedOpcionId);
                $.get(url, function(data) {
                    $('#deleteModalContent').html(data);
                    $('#deleteModal').modal('show');
                    console.log('Delete modal loaded with data:', data);
                }).fail(function(xhr) {
                    console.error('Error loading delete modal:', xhr.responseText);
                    toastr.error('Error al cargar el formulario de eliminación: ' + xhr.status + ' - ' + xhr.statusText);
                });
            } else {
                toastr.warning('Por favor seleccione una opción para eliminar');
            }
        });

        $('#toggleSelected').click(function() {
            if (selectedOpcionId) {
                if (confirm('¿Estás seguro de que quieres cambiar el estado de esta opción?')) {
                    var url = '@Url.Action("ToggleEstado", new { id = "__id__" })'.replace('__id__', selectedOpcionId);
                    $.post(url, function(data) {
                        if (data.success) {
                            toastr.success('Estado de la opción cambiado exitosamente');
                            // Refresh the page to update the status
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            toastr.error('Error al cambiar el estado de la opción');
                        }
                    });
                }
            }
        });
    </script>

    <!-- Search and Filter JavaScript -->
    <script>
        $(document).ready(function() {
            // Real-time search functionality
            $('#searchInput').on('input', function() {
                var searchText = $(this).val().toLowerCase();
                filterTable(searchText, $('#titleFilter').val(), $('#urlFilter').val(), $('#moduleFilter').val(), $('#stateFilter').val());
            });

            // Apply filters button
            $('#applyFilters').click(function() {
                var searchText = $('#searchInput').val().toLowerCase();
                var titleFilter = $('#titleFilter').val().toLowerCase();
                var urlFilter = $('#urlFilter').val().toLowerCase();
                var moduleFilter = $('#moduleFilter').val();
                var stateFilter = $('#stateFilter').val();

                filterTable(searchText, titleFilter, urlFilter, moduleFilter, stateFilter);
            });

            // Clear filters button
            $('#clearFilters').click(function() {
                $('#searchInput').val('');
                $('#titleFilter').val('');
                $('#urlFilter').val('');
                $('#moduleFilter').val('');
                $('#stateFilter').val('');

                // Show all rows
                $('table tbody tr').show();
            });

            function filterTable(searchText, titleFilter, urlFilter, moduleFilter, stateFilter) {
                $('table tbody tr').each(function() {
                    var row = $(this);
                    var title = row.find('td:eq(1)').text().toLowerCase();
                    var url = row.find('td:eq(2)').text().toLowerCase();
                    var module = row.find('td:eq(4)').text();
                    var state = row.find('td:eq(8)').text().trim();

                    // Check if row matches all filter criteria
                    var matchesSearch = true;
                    var matchesTitle = true;
                    var matchesUrl = true;
                    var matchesModule = true;
                    var matchesState = true;

                    // Apply search filter (searches in all columns)
                    if (searchText) {
                        matchesSearch = title.includes(searchText) ||
                                      url.includes(searchText) ||
                                      module.includes(searchText) ||
                                      state.includes(searchText);
                    }

                    // Apply title filter
                    if (titleFilter) {
                        matchesTitle = title.includes(titleFilter);
                    }

                    // Apply URL filter
                    if (urlFilter) {
                        matchesUrl = url.includes(urlFilter);
                    }

                    // Apply module filter
                    if (moduleFilter) {
                        matchesModule = module === moduleFilter;
                    }

                    // Apply state filter
                    if (stateFilter) {
                        matchesState = state === stateFilter;
                    }

                    // Show/hide row based on all filters
                    if (matchesSearch && matchesTitle && matchesUrl && matchesModule && matchesState) {
                        row.show();
                    } else {
                        row.hide();
                    }
                });
            }

            // Add individual column filter inputs with real-time filtering
            $('#titleFilter').on('input', function() {
                var searchText = $('#searchInput').val().toLowerCase();
                var titleFilter = $(this).val().toLowerCase();
                var urlFilter = $('#urlFilter').val().toLowerCase();
                var moduleFilter = $('#moduleFilter').val();
                var stateFilter = $('#stateFilter').val();

                filterTable(searchText, titleFilter, urlFilter, moduleFilter, stateFilter);
            });

            $('#urlFilter').on('input', function() {
                var searchText = $('#searchInput').val().toLowerCase();
                var titleFilter = $('#titleFilter').val().toLowerCase();
                var urlFilter = $(this).val().toLowerCase();
                var moduleFilter = $('#moduleFilter').val();
                var stateFilter = $('#stateFilter').val();

                filterTable(searchText, titleFilter, urlFilter, moduleFilter, stateFilter);
            });

            $('#moduleFilter, #stateFilter').change(function() {
                var searchText = $('#searchInput').val().toLowerCase();
                var titleFilter = $('#titleFilter').val().toLowerCase();
                var urlFilter = $('#urlFilter').val().toLowerCase();
                var moduleFilter = $('#moduleFilter').val();
                var stateFilter = $('#stateFilter').val();

                filterTable(searchText, titleFilter, urlFilter, moduleFilter, stateFilter);
            });
        });
    </script>
}