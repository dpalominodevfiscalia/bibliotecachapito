@model IEnumerable<BibliotecaDB.Models.CompraDetalle>

@{
    ViewData["Title"] = "Detalles de Compra";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Detalles de Compra</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Compras")">Compras</a></li>
                        <li class="breadcrumb-item active">Detalles</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Detalles de Compra #@ViewBag.IdCompra</h3>
                            @if (ViewContext.HttpContext.Items["HasCreateCompraDetallePermission"] as bool? == true)
                            {
                                <div class="card-tools">
                                    <a href="@Url.Action("Create", new { idCompra = ViewBag.IdCompra })" class="btn btn-primary" data-toggle="modal" data-target="#createModal">
                                        <i class="fas fa-plus"></i> Nuevo Detalle
                                    </a>
                                    <a href="@Url.Action("Index", "Compras")" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Volver a Compras
                                    </a>
                                </div>
                            }
                        </div>
                        <div class="card-body">
                            <table id="compraDetallesTable" class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Producto</th>
                                        <th>Descripci√≥n</th>
                                        <th>Unidad</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unitario</th>
                                        <th>Total Parcial</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td>@item.Id</td>
                                            <td>@(item.Producto?.Nombre ?? "N/A")</td>
                                            <td>@item.Descripcion</td>
                                            <td>@item.UnidadMedida</td>
                                            <td>@item.CantidadSolicitada</td>
                                            <td>@item.PrecioUnitario</td>
                                            <td>@item.TotalParcial</td>
                                            <td>
                                                <span class="badge @(item.Estado == "Activo" ? "badge-success" : "badge-danger")">
                                                    @item.Estado
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    @if (ViewContext.HttpContext.Items["HasDetailsCompraDetallePermission"] as bool? == true)
                                                    {
                                                        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#detailsModal-@item.Id" data-id="@item.Id">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    }
                                                    @if (ViewContext.HttpContext.Items["HasEditCompraDetallePermission"] as bool? == true)
                                                    {
                                                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editModal-@item.Id" data-id="@item.Id">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    }
                                                    @if (ViewContext.HttpContext.Items["HasDeleteCompraDetallePermission"] as bool? == true)
                                                    {
                                                        <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteModal-@item.Id" data-id="@item.Id">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    }
                                                    @if (ViewContext.HttpContext.Items["HasToggleCompraDetallePermission"] as bool? == true)
                                                    {
                                                        <button class="btn btn-warning btn-sm toggle-estado" data-id="@item.Id" data-estado="@item.Estado">
                                                            <i class="fas @(item.Estado == "Activo" ? "fa-toggle-on" : "fa-toggle-off")"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Nuevo Detalle de Compra</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="createPartialContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modals will be loaded dynamically via AJAX -->

@section Scripts {
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css" rel="stylesheet" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize DataTable
            $('#compraDetallesTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                },
                "responsive": true,
                "autoWidth": false
            });

            // Load create partial on modal show
            $('#createModal').on('shown.bs.modal', function() {
                $('#createPartialContainer').load('/CompraDetalles/Create/@ViewBag.IdCompra', function() {
                    // Initialize form validation and other scripts if needed
                });
            });

            // Handle dynamic modals for details, edit, delete
            $(document).on('click', '[data-target^="#detailsModal-"], [data-target^="#editModal-"], [data-target^="#deleteModal-"]', function() {
                var id = $(this).data('id');
                var action = $(this).closest('button').hasClass('btn-info') ? 'Details' :
                             $(this).closest('button').hasClass('btn-primary') ? 'Edit' : 'Delete';

                var modalId = $(this).attr('data-target');
                $(modalId).on('shown.bs.modal', function() {
                    var container = $(modalId + ' .modal-body div:first');
                    container.load('/CompraDetalles/' + action + '/' + id, function() {
                        // Initialize form validation and other scripts if needed
                    });
                });
            });

            // Handle toggle estado
            $(document).on('click', '.toggle-estado', function() {
                var id = $(this).data('id');
                var currentEstado = $(this).data('estado');

                $.post('/CompraDetalles/ToggleEstado/' + id, function() {
                    // Reload the page to see changes
                    location.reload();
                });
            });
        });
    </script>
}