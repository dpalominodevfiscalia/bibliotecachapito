@model IEnumerable<BibliotecaDB.Models.Solicitud>

@{
    ViewData["Title"] = "Solicitudes";

    // Helper functions for badge classes - defined here so they're available in Razor
    Func<string, string> GetPriorityBadgeClass = (priority) =>
    {
        switch(priority?.ToLower())
        {
            case "alta": return "badge-danger";
            case "media": return "badge-warning";
            case "baja": return "badge-info";
            default: return "badge-secondary";
        }
    };

    Func<string, string> GetStatusBadgeClass = (status) =>
    {
        switch(status?.ToLower())
        {
            case "pendiente": return "badge-warning";
            case "aprobado": return "badge-success";
            case "rechazado": return "badge-danger";
            case "atendido": return "badge-info";
            default: return "badge-secondary";
        }
    };
}

<div class="d-flex justify-content-between mb-3">
    <div>
        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#createModal" title="Crear Nueva Solicitud">
            <i class="fas fa-plus"></i> Crear Nuevo
        </button>
    </div>
    <div class="action-buttons">
        @if (ViewContext.HttpContext.Items["HasEditRequestPermission"] as bool? ?? false)
        {
            <button type="button" class="btn btn-primary btn-sm" id="editSelected" disabled title="Editar Solicitud Seleccionada">
                <i class="fas fa-edit"></i> Editar
            </button>
        }
        @if (ViewContext.HttpContext.Items["HasDetailsRequestPermission"] as bool? ?? false)
        {
            <button type="button" class="btn btn-info btn-sm" id="detailsSelected" disabled title="Ver Detalles de la Solicitud">
                <i class="fas fa-info-circle"></i> Detalles
            </button>
        }
        @if (ViewContext.HttpContext.Items["HasDeleteRequestPermission"] as bool? ?? false)
        {
            <button type="button" class="btn btn-danger btn-sm" id="deleteSelected" disabled title="Eliminar Solicitud Seleccionada">
                <i class="fas fa-trash"></i> Eliminar
            </button>
        }
        @if (ViewContext.HttpContext.Items["HasToggleRequestPermission"] as bool? ?? false)
        {
            <button type="button" class="btn btn-warning btn-sm" id="toggleSelected" disabled title="Cambiar Estado de la Solicitud">
                <i class="fas fa-toggle-on"></i> Cambiar Estado
            </button>
        }
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>
                <input type="radio" name="selectRequest" id="selectAll" onchange="toggleSelectAll()">
            </th>
            <th>
                @Html.DisplayNameFor(model => model.IdSolicitud)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.AreaSolicitante)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ProductoServicio)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Prioridad)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.EstadoSolicitud)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.FechaRequerida)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Estado)
            </th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                <input type="radio" name="selectRequest" class="request-radio" value="@item.Id" data-requestname="Solicitud @item.IdSolicitud" onchange="handleRequestSelection()">
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.IdSolicitud)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.AreaSolicitante)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ProductoServicio)
            </td>
            <td>
                <span class="badge @GetPriorityBadgeClass(item.Prioridad)">
                    @Html.DisplayFor(modelItem => item.Prioridad)
                </span>
            </td>
            <td>
                <span class="badge @GetStatusBadgeClass(item.EstadoSolicitud)">
                    @Html.DisplayFor(modelItem => item.EstadoSolicitud)
                </span>
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.FechaRequerida)
            </td>
            <td>
               @if (item.Estado == "Activo")
            {
                <span class="badge badge-success">
                    <i class="fas fa-check-circle"></i> @item.Estado
                </span>
            }
            else
            {
                <span class="badge badge-danger">
                    <i class="fas fa-times-circle"></i> @item.Estado
                </span>
            }
            </td>
        </tr>
}
    </tbody>
</table>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Crear Solicitud</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="createModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Solicitud</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="editModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalles de Solicitud</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="detailsModalContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Eliminar Solicitud</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded via AJAX -->
                <div id="deleteModalContent"></div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        var selectedRequestId = null;
        var selectedRequestName = null;

        function handleRequestSelection() {
            var radio = event.target;
            if (radio.checked) {
                selectedRequestId = radio.value;
                selectedRequestName = radio.dataset.requestname;

                // Get the status of the selected request
                var row = $(radio).closest('tr');
                var status = row.find('td:eq(4)').text().trim(); // Estado is the 5th column (index 4)

                // Enable action buttons only if status is "Activo"
                var isActive = status === 'Activo';
                $('#editSelected').prop('disabled', !isActive);
                $('#detailsSelected').prop('disabled', false); // Always allow details
                $('#deleteSelected').prop('disabled', !isActive);
                $('#toggleSelected').prop('disabled', false); // Always allow toggle

                // Add visual feedback
                console.log('Request selected: ' + selectedRequestName + ' (ID: ' + selectedRequestId + ', Status: ' + status + ')');
                toastr.info('Solicitud seleccionada: ' + selectedRequestName + ' (Estado: ' + status + ')');
            }
        }

        function toggleSelectAll() {
            var radios = document.querySelectorAll('.request-radio');
            radios.forEach(function(radio) {
                radio.checked = false;
            });
            selectedRequestId = null;
            selectedRequestName = null;

            // Disable action buttons
            $('#editSelected').prop('disabled', true);
            $('#detailsSelected').prop('disabled', true);
            $('#deleteSelected').prop('disabled', true);
            $('#toggleSelected').prop('disabled', true);
        }

        $(document).ready(function() {
            // Handle modal loading via AJAX
            $('#createModal').on('show.bs.modal', function (event) {
                var modal = $(this);
                $.get('@Url.Action("Create")', function(data) {
                    modal.find('#createModalContent').html(data);
                });
            });

            // Handle action buttons
            $('#editSelected').click(function() {
                if (selectedRequestId) {
                    var url = '@Url.Action("Edit", new { id = "__id__" })'.replace('__id__', selectedRequestId);
                    $.get(url, function(data) {
                        $('#editModalContent').html(data);
                        $('#editModal').modal('show');
                    });
                }
            });

            $('#detailsSelected').click(function() {
                if (selectedRequestId) {
                    var url = '@Url.Action("Details", new { id = "__id__" })'.replace('__id__', selectedRequestId);
                    $.get(url, function(data) {
                        $('#detailsModalContent').html(data);
                        $('#detailsModal').modal('show');
                    });
                }
            });

            $('#deleteSelected').click(function() {
                if (selectedRequestId) {
                    var url = '@Url.Action("Delete", new { id = "__id__" })'.replace('__id__', selectedRequestId);
                    $.get(url, function(data) {
                        $('#deleteModalContent').html(data);
                        $('#deleteModal').modal('show');
                    });
                }
            });

            $('#toggleSelected').click(function() {
                if (selectedRequestId) {
                    if (confirm('¿Estás seguro de que quieres cambiar el estado de esta solicitud?')) {
                        var url = '@Url.Action("ToggleEstado", new { id = "__id__" })'.replace('__id__', selectedRequestId);
                        $.post(url, function(data) {
                            if (data.success) {
                                toastr.success('Estado de la solicitud cambiado exitosamente');
                                // Refresh the page to update the status
                                setTimeout(function() {
                                    location.reload();
                                }, 2000);
                            } else {
                                toastr.error('Error al cambiar el estado de la solicitud');
                            }
                        });
                    }
                }
            });

            // Handle form submission via AJAX
            $(document).on('submit', 'form', function(e) {
                e.preventDefault();
                var form = $(this);
                var url = form.attr('action');
                var method = form.attr('method') || 'POST';

                // Get form data including anti-forgery token
                var formData = new FormData(form[0]);

                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(result) {
                        if (result.success) {
                            // Show success message
                            if (result.message) {
                                toastr.success(result.message);
                            }
                            // Close modal and refresh page after delay
                            $('.modal').modal('hide');
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            // Show validation errors
                            form.replaceWith(result);
                        }
                    },
                    error: function(xhr) {
                        // Handle error
                        console.log(xhr.responseText);
                        if (xhr.status == 200 && xhr.responseText) {
                            // This might be HTML with validation errors
                            form.replaceWith(xhr.responseText);
                        } else if (xhr.status == 400 && xhr.responseText) {
                            // Handle validation errors
                            form.replaceWith(xhr.responseText);
                        }
                    }
                });
            });
        });
    </script>
}